# Как вносить изменения и собирать проект


1. Склонируйте репозиторий git clone 
2. Сначала установите esp-idf, можно сделать это по инструкции в Readme внутри ports/esp32. **ВЕРСИЯ idf 5.4.1** ЭТО важно, может не собраться проект на других версиях
3. Активируйте окружние esp.idf(также приведено в readme внутри ports/esp32)
4. сделайте `make -C mpy-cross` внутри корня проекта
5. направляйтесь в папку ports/esp32 (cd ports/esp32)
6. make submodules
7. Теперь можете вносить изменения, если это нужно
8. Сбилдите проект `idf.py build`

    Естественно, первые 6 пунктов выполнить нужно одноразово
9. **ПРОВЕРЬТЕ НА ЛОКАЛЬНОЙ ПАЛТЕ** перед отправкой изменений на удаленных роботов. Потому что несмотря на успешную сборку проекта, вполне может оказаться, что при загрузке на esp32 она **будет бесконечно перезагружаться**.
10. Чтобы загрузить на плату используйте `idf.py flash` или с указанием порта `idf.py -p /dev/ttyUSB0 flash`
11. Зайдите в serial monitor. Рекомендую arduino, как самый удобный
12. При первой загрузке на плату она будет подключаться к wifi у которого: ssid: ssid, pass: 12345678. Можно сделать точку доступа на телефоне
13. Можно заменить пароль через serial monitor для этого используйте help; там всё отобразится, например **set string wifi_ssid=ssid** и **set string wifi_pass=12345678**
14. Далее рекомендую использовать python скрипт для загрузки всех параметров на плату. Скрипт находится **ports/esp32/settings_writer**. Параметры меняются через json файл. чтобы использовать: `python mqtt_writer.py settings_0.json`. Далее следуйте указаниям. СТАНДАРТНЫЙ ТОПИК ПРИ ПЕРВОЙ ЗАГРУЗКЕ `lfpm_init/system/input` используйте его в первый раз, а затем можете выбрать 1, чтобы записать все новые настройки, НО будьте внимательны, чтобы не перезаписать на нерабочий **wifi** или на топик, который используется уже другим роботом. Стандартные топики в формате lfmp1/..., lfmp2/..., .... Если что вы сможете всё исправить через serial monitor в ручном режиме.
15. Рекомендую проверить, что всё записалось корректно, посмотреть в serial monitor, что плата читала параметры, а потом перезагрузить плату

## Загрузка обновлений

1. Загружайте ТОЛЬКО после того, как вы сбилдили новый образ прошивки(.bin файл) и оттестировали его локально, чтобы не пришлось потом ехать к другим роботам и спасать их
2. Вам нужно передать micropython.bin файл на удаленный сервер компилятор, сделать это можно с помощью scp

    ```bash
    scp build/micropython.bin user@compiler_ip:
    ```

    *Замечание*: скорее всего ваш файл сохранился в директории build, под названием micropython.bin, если вы следовали инструкциям
3. Далее поместите файл на компиляторе куда нужно(вероятно сюда /var/lib/docker/volumes/docker_bin_files/_data/micropython)

    ```bash
    cp micropython.bin /var/lib/docker/volumes/docker_bin_files/_data/micropython
    ```
4. Возможно придется добавить ключ в redis, краткая инстуркция ниже

    - `docker exec -it docker-compiler-redis-1 redis-cli`
    - `KEYS *` - если в выводе нет ключей *micropython* или похожих, то точно нужно добавить
    - ЕСЛИ НЕТ КЛЮЧЕЙ ИДЕМ ДАЛЬШЕ ПО ШАГАМ
    - `HSET micropython_file_name bin_name micropython.bin protected 0` - именно такая команда, менять можно только *micropython.bin* если у вас другое название файла прошивки
    - `SET micropython micropython_file_name`  - именно такая команда


## Примеры команд

примеры команд собраны в settings_writer/commands.md
